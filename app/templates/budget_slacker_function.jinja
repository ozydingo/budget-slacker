{% set name = env['deployment'] + '-' + env['name'] %}
{% set trigger = properties['trigger'] or {'httpsTrigger': {}} %}

{% set function_name = name + "-function" %}
{% set policy_name = name + "-policy" %}

resources:
  - name: {{ name }}
    type: templates/cloud_function.py
    properties:
      codeLocation: {{ properties['codeLocation'] }}
      codeBucket: budget-slacker-deploy
      codeBucketObject: {{ env['name'] }}.zip
      location: us-east1
      timeout: 60s
      runtime: nodejs8
      availableMemoryMb: 256
      entryPoint: main
      trigger:
        {{ trigger }}
  - name: {{ name }}-policy
    action: gcp-types/cloudfunctions-v1:cloudfunctions.projects.locations.functions.setIamPolicy
    properties:
      resource: $(ref.{{ name }}.name)
      policy:
        bindings:
          - members:
            - serviceAccount:{{ env['project'] }}@appspot.gserviceaccount.com
            role: "roles/cloudfunctions.invoker"

{% if 'httpsTrigger' in trigger %}
outputs:
  - name: url
    value: $(ref.{{ name }}.url)
{% endif %}
